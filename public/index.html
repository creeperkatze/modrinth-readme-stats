<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Generate beautiful, embeddable cards and badges for Modrinth projects, users, organizations, and collections." />
        <meta property="og:title" content="Modrinth Embeds" />
        <meta property="og:description" content="Generate beautiful, embeddable cards and badges for Modrinth projects, users, organizations, and collections." />
        <meta property="og:image" content="/favicon.svg" />
        <meta property="og:type" content="website" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
        <title>Modding Embeds</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            "modrinth-green": "#1bd96a",
                            "bg-dark": "#06060d",
                            "card-bg": "#101014",
                            "section-bg": "#1a1a1e",
                            "input-bg": "#3c3c40",
                            "border-dark": "#3a3a4a",
                            "text-primary": "#b0bac5",
                            "text-secondary": "#c4cfdd",
                            "text-muted": "#929aa3",
                            "text-bright": "#ecf9fb",
                            yellow: "#fbbf24",
                            red: "#ef4444",
                        },
                    },
                },
            };
        </script>
        <style>
            body {
                background: #06060d url("/images/landing.webp");
                font-family:
                    Inter,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Ubuntu,
                    sans-serif;
            }
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }
            .loader-icon {
                animation: spin 1s linear infinite;
            }
            input[type="checkbox"]:checked::after {
                content: "";
                position: absolute;
                left: 50%;
                top: 50%;
                width: 6px;
                height: 12px;
                border: solid #000;
                border-width: 0 2.5px 2.5px 0;
                transform: translate(-50%, -50%) rotate(45deg);
            }
            input[type="range"] {
                -webkit-appearance: none;
                appearance: none;
                width: 100%;
                height: 6px;
                background: #3c3c40;
                border-radius: 3px;
                outline: none;
            }
            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 18px;
                height: 18px;
                background: #1bd96a;
                cursor: pointer;
                border-radius: 50%;
                transition: all 0.2s;
            }
            input[type="range"]::-webkit-slider-thumb:hover {
                background: #1fef76;
                transform: scale(1.1);
            }
            input[type="range"]::-moz-range-thumb {
                width: 18px;
                height: 18px;
                background: #1bd96a;
                cursor: pointer;
                border-radius: 50%;
                border: none;
                transition: all 0.2s;
            }
            input[type="range"]::-moz-range-thumb:hover {
                background: #1fef76;
                transform: scale(1.1);
            }
            .color-btn {
                width: 39px;
                height: 39px;
                padding: 0;
                border: 2px solid transparent;
                border-radius: 0.5rem;
                cursor: pointer;
                transition: all 0.2s;
                flex-shrink: 0;
            }
            .color-btn-selected {
                border-color: #fff !important;
            }
            #manualColorPickerContainer.color-btn {
                width: 39px;
                height: 39px;
                padding: 0;
                border-radius: 0.5rem;
            }
        </style>
    </head>
    <body class="min-h-screen flex flex-col justify-center items-center pt-10 px-5 pb-0 font-medium text-text-primary overflow-y-scroll">
        <div class="bg-card-bg border border-border-dark rounded-2xl p-4 lg:p-8 max-w-[1200px] w-full shadow-[0_4px_16px_rgba(0,0,0,0.4)]">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div>
                    <a href="/" class="inline-block no-underline">
                        <div class="flex items-center gap-4 mb-2">
                            <img src="/favicon.svg" alt="Modrinth Logo" class="w-8 h-8 mt-0.5" />
                            <h1 class="text-modrinth-green mb-0 text-3xl font-extrabold">Modfolio</h1>
                        </div>
                    </a>
                    <p class="mb-8 text-sm opacity-80">Generate embeddable cards and badges for Modrinth projects, users, organizations, and collections.</p>

                    <div class="bg-section-bg border border-border-dark rounded-xl px-4 py-2 mb-4">
                        <div class="mb-0">
                            <button id="basicToggle" class="w-full flex items-center justify-between bg-transparent text-text-secondary py-2 px-0 text-sm font-semibold border-none cursor-pointer">
                                <h2 class="text-text-secondary text-2xl font-semibold">Configuration</h2>
                                <svg id="basicChevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-200 rotate-180">
                                    <path d="m6 9 6 6 6-6" />
                                </svg>
                            </button>
                        </div>

                        <div id="basicContent">
                            <div class="mb-2">
                                <h3 class="text-text-secondary text-base font-semibold mt-2 mb-1">URL</h3>
                                <input type="text" id="modrinthUrl" placeholder="https://modrinth.com/mod/fabric-api" class="w-full py-2.5 px-3 bg-input-bg border-2 border-transparent rounded-xl text-text-bright text-sm font-medium transition-[border-color] duration-100 focus:outline-none focus:border-modrinth-green" />
                            </div>

                            <hr class="my-4 border-0 border-t border-border-dark relative divider" />

                            <div class="mb-2">
                                <h3 class="text-text-secondary text-base font-semibold mb-1">Platform</h3>
                                <div class="flex gap-2">
                                    <button id="platformModrinth" class="flex-1 py-2.5 px-3 bg-modrinth-green text-black border-none rounded-xl text-sm font-semibold cursor-pointer transition-[filter] duration-200 hover:brightness-110">
                                        Modrinth
                                    </button>
                                    <button id="platformCurseforge" class="flex-1 py-2.5 px-3 bg-input-bg text-text-bright border border-border-dark rounded-xl text-sm font-semibold cursor-pointer transition-[filter] duration-200 hover:brightness-110">
                                        CurseForge
                                    </button>
                                </div>
                            </div>

                            <hr class="my-4 border-0 border-t border-border-dark relative divider" />

                            <div class="mb-2">
                                <h3 class="text-text-secondary text-base font-semibold mb-1">Type</h3>
                                <select id="embedType" class="w-full py-2.5 px-3 bg-input-bg border-2 border-transparent rounded-xl text-text-bright text-sm font-medium transition-[border-color] duration-100 focus:outline-none focus:border-modrinth-green">
                                    <option value="card">Card</option>
                                    <option value="badge">Badge</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <h3 class="text-text-secondary text-base font-semibold mb-1">Target</h3>
                                <select id="targetType" class="w-full py-2.5 px-3 bg-input-bg border-2 border-transparent rounded-xl text-text-bright text-sm font-medium transition-[border-color] duration-100 focus:outline-none focus:border-modrinth-green">
                                    <option value="user">User</option>
                                    <option value="project">Project</option>
                                    <option value="organization">Organization</option>
                                    <option value="collection">Collection</option>
                                </select>
                            </div>

                            <div class="mb-2 hidden" id="badgeSection">
                                <h3 class="text-text-secondary text-base font-semibold mb-1">Badge Metric</h3>
                                <select id="badgeMetric" class="w-full py-2.5 px-3 bg-input-bg border-2 border-transparent rounded-xl text-text-bright text-sm font-medium transition-[border-color] duration-100 focus:outline-none focus:border-modrinth-green">
                                    <option value="downloads">Downloads</option>
                                    <option value="followers">Followers</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <h3 class="text-text-secondary text-base font-semibold mb-1" id="valueLabel">Value</h3>
                                <input type="text" id="identifier" placeholder="Enter username or project slug" class="w-full py-2.5 px-3 bg-input-bg border-2 border-transparent rounded-xl text-text-bright text-sm font-medium transition-[border-color] duration-100 focus:outline-none focus:border-modrinth-green" />
                            </div>
                        </div>
                    </div>

                    <div class="bg-section-bg border border-border-dark rounded-xl px-4 py-2 mb-4 mb-4">
                        <div class="mb-0">
                            <button id="customizationToggle" class="w-full flex items-center justify-between bg-transparent text-text-secondary py-2 px-0 text-sm font-semibold border-none cursor-pointer">
                                <h2 class="text-text-secondary text-2xl font-semibold">Customization</h2>
                                <svg id="customizationChevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-200">
                                    <path d="m6 9 6 6 6-6" />
                                </svg>
                            </button>
                        </div>

                        <div id="customizationContent" class="hidden mt-2">
                            <div class="mb-2" id="showProjectsSection">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="showProjects" checked class="!w-[18px] h-[18px] min-w-[18px] flex-shrink-0 appearance-none bg-input-bg border-2 border-text-muted rounded cursor-pointer relative transition-all duration-200 p-0 checked:bg-modrinth-green checked:border-modrinth-green" />
                                    <span class="text-base text-text-secondary">Show Projects</span>
                                </label>
                            </div>

                            <div class="mb-2" id="maxProjectsSection">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-text-secondary text-base font-semibold">Max Projects</h3>
                                    <span class="text-modrinth-green text-base font-bold" id="maxProjectsValue">5</span>
                                </div>
                                <input type="range" id="maxProjects" min="1" max="10" value="5" class="w-full" />
                            </div>

                            <div class="mb-2 hidden" id="showVersionsSection">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="showVersions" checked class="!w-[18px] h-[18px] min-w-[18px] flex-shrink-0 appearance-none bg-input-bg border-2 border-text-muted rounded cursor-pointer relative transition-all duration-200 p-0 checked:bg-modrinth-green checked:border-modrinth-green" />
                                    <span class="text-base text-text-secondary" id="showVersionsLabel">Show Versions</span>
                                </label>
                            </div>

                            <div class="mb-2 hidden" id="maxVersionsSection">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-text-secondary text-base font-semibold" id="maxVersionsLabel">Max Versions</h3>
                                    <span class="text-modrinth-green text-base font-bold" id="maxVersionsValue">5</span>
                                </div>
                                <input type="range" id="maxVersions" min="1" max="10" value="5" class="w-full" />
                            </div>

                            <div class="mb-2 hidden" id="relativeTimeSection">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="relativeTime" checked class="!w-[18px] h-[18px] min-w-[18px] flex-shrink-0 appearance-none bg-input-bg border-2 border-text-muted rounded cursor-pointer relative transition-all duration-200 p-0 checked:bg-modrinth-green checked:border-modrinth-green" />
                                    <span class="text-base text-text-secondary">Relative Time</span>
                                </label>
                            </div>

                            <div class="mb-2 hidden" id="showSparklinesSection">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="showSparklines" checked class="!w-[18px] h-[18px] min-w-[18px] flex-shrink-0 appearance-none bg-input-bg border-2 border-text-muted rounded cursor-pointer relative transition-all duration-200 p-0 checked:bg-modrinth-green checked:border-modrinth-green" />
                                    <span class="text-base text-text-secondary">Sparkline Graphs</span>
                                </label>
                            </div>

                            <div class="mb-2">
                                <h3 class="text-text-secondary text-base font-semibold mb-1">Accent Color</h3>
                                <div class="flex flex-wrap items-center gap-2">
                                    <div id="colorButtons" class="flex flex-wrap gap-2"></div>

                                    <div id="manualColorPickerContainer" class="color-btn relative flex items-center justify-center bg-input-bg overflow-hidden border-2 border-border-dark">
                                        <input type="color" id="manualColorPicker" value="#1bd96a" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />

                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none text-text-secondary">
                                            <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                            <path d="m15 5 4 4" />
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-2">
                                <h3 class="text-text-secondary text-base font-semibold mb-1">Background Color</h3>
                                <div class="flex flex-wrap items-center gap-2">
                                    <div id="bgColorButtons" class="flex flex-wrap gap-2"></div>

                                    <div id="manualBgColorPickerContainer" class="color-btn relative flex items-center justify-center bg-input-bg overflow-hidden border-2 border-border-dark">
                                        <input type="color" id="manualBgColorPicker" value="#ffffff" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />

                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none text-text-secondary">
                                            <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                            <path d="m15 5 4 4" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <div>
                        <h2 class="flex justify-between items-center text-text-secondary text-lg font-semibold">
                            <span>Preview</span>
                            <span class="flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow hidden" id="generationIcon">
                                    <path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z" />
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow loader-icon hidden" id="loaderIcon"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>
                                <span id="generationTime" class="text-yellow"></span>
                            </span>
                        </h2>
                        <div id="apiSlowWarning" class="hidden mb-3 bg-yellow/10 border border-yellow/30 rounded-lg px-3 py-2 text-sm text-yellow">
                            <span class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert-icon lucide-triangle-alert">
                                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3" />
                                    <path d="M12 9v4" />
                                    <path d="M12 17h.01" />
                                </svg>
                                <span id="apiSlowWarningText">The Modrinth API is responding slowly. Embeds may take longer to load.</span>
                            </span>
                        </div>
                        <div id="apiErrorWarning" class="hidden mb-3 bg-red/10 border border-red/30 rounded-lg px-3 py-2 text-sm text-red">
                            <span class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-alert-icon lucide-circle-alert">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="12" x2="12" y1="8" y2="12"/>
                                    <line x1="12" x2="12.01" y1="16" y2="16"/>
                                </svg>
                                <span id="apiErrorWarningText">The Modrinth API is currently down. Check <a href="https://status.modrinth.com" target="_blank" class="underline hover:text-red-80">status.modrinth.com</a> for updates.</span>
                            </span>
                        </div>
                        <div class="bg-section-bg border border-border-dark rounded-xl min-h-[460px] flex items-center justify-center text-text-muted p-4" id="previewContainer">
                            <span id="previewPlaceholder">Your embed will appear here</span>
                            <a id="previewLink" href="" target="_blank" class="hidden">
                                <img id="previewImg" src="" alt="Preview" class="max-w-full" />
                            </a>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-text-secondary text-lg font-semibold">Markdown</h2>
                        <div class="bg-section-bg border border-border-dark rounded-xl p-3 flex items-center font-mono text-xs break-all text-text-muted" id="markdownOutput">
                            <span id="markdownPlaceholder">Your markdown code will appear here</span>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-text-secondary text-lg font-semibold">HTML</h2>
                        <div class="bg-section-bg border border-border-dark rounded-xl p-3 flex items-center font-mono text-xs break-all text-text-muted" id="htmlOutput">
                            <span id="htmlPlaceholder">Your HTML code will appear here</span>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-text-secondary text-lg font-semibold">URL</h2>
                        <div class="bg-section-bg border border-border-dark rounded-xl p-3 flex items-center font-mono text-xs break-all text-text-muted" id="urlOutput">
                            <span id="urlPlaceholder">Your URL will appear here</span>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2">
                        <button class="py-2.5 px-4 bg-modrinth-green text-black border-none rounded-xl text-sm font-semibold cursor-pointer transition-[filter] duration-200 hover:brightness-110 flex items-center gap-2 disabled:bg-input-bg disabled:text-text-primary disabled:opacity-50 disabled:cursor-not-allowed" onclick="copyMarkdown()" id="copyMarkdownBtn" disabled>
                            <span>Copy Markdown</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brackets-icon lucide-brackets">
                                <path d="M16 3h3a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1h-3" />
                                <path d="M8 21H5a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h3" />
                            </svg>
                        </button>

                        <button class="py-2.5 px-4 bg-modrinth-green text-black border-none rounded-xl text-sm font-semibold cursor-pointer transition-[filter] duration-200 hover:brightness-110 flex items-center gap-2 disabled:bg-input-bg disabled:text-text-primary disabled:opacity-50 disabled:cursor-not-allowed" onclick="copyHtml()" id="copyHtmlBtn" disabled>
                            <span>Copy HTML</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-code-icon lucide-code">
                                <path d="m16 18 6-6-6-6" />
                                <path d="m8 6-6 6 6 6" />
                            </svg>
                        </button>

                        <button class="py-2.5 px-4 bg-modrinth-green text-black border-none rounded-xl text-sm font-semibold cursor-pointer transition-[filter] duration-200 hover:brightness-110 flex items-center gap-2 disabled:bg-input-bg disabled:text-text-primary disabled:opacity-50 disabled:cursor-not-allowed" onclick="copyUrl()" id="copyUrlBtn" disabled>
                            <span>Copy URL</span>
                            <svg id="Discord-Logo" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 126.644 96" fill="currentColor">
                                <path
                                    d="M81.15,0c-1.2376,2.1973-2.3489,4.4704-3.3591,6.794-9.5975-1.4396-19.3718-1.4396-28.9945,0-.985-2.3236-2.1216-4.5967-3.3591-6.794-9.0166,1.5407-17.8059,4.2431-26.1405,8.0568C2.779,32.5304-1.6914,56.3725.5312,79.8863c9.6732,7.1476,20.5083,12.603,32.0505,16.0884,2.6014-3.4854,4.8998-7.1981,6.8698-11.0623-3.738-1.3891-7.3497-3.1318-10.8098-5.1523.9092-.6567,1.7932-1.3386,2.6519-1.9953,20.281,9.547,43.7696,9.547,64.0758,0,.8587.7072,1.7427,1.3891,2.6519,1.9953-3.4601,2.0457-7.0718,3.7632-10.835,5.1776,1.97,3.8642,4.2683,7.5769,6.8698,11.0623,11.5419-3.4854,22.3769-8.9156,32.0509-16.0631,2.626-27.2771-4.496-50.9172-18.817-71.8548C98.9811,4.2684,90.1918,1.5659,81.1752.0505l-.0252-.0505ZM42.2802,65.4144c-6.2383,0-11.4159-5.6575-11.4159-12.6535s4.9755-12.6788,11.3907-12.6788,11.5169,5.708,11.4159,12.6788c-.101,6.9708-5.026,12.6535-11.3907,12.6535ZM84.3576,65.4144c-6.2637,0-11.3907-5.6575-11.3907-12.6535s4.9755-12.6788,11.3907-12.6788,11.4917,5.708,11.3906,12.6788c-.101,6.9708-5.026,12.6535-11.3906,12.6535Z"
                                />
                            </svg>
                        </button>

                        <button id="resetBtn" class="py-2.5 px-4 bg-input-bg text-text-bright border border-border-dark rounded-xl text-sm font-semibold flex items-center gap-2 hover:brightness-110 cursor-pointer transition-[filter] duration-200">
                            <span>Reset</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                                <path d="M3 3v5h5" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center py-8 px-5 pt-8 text-base text-text-muted font-semibold">
            Made with &hearts; by <a href="https://github.com/creeperkatze" target="_blank" class="text-modrinth-green no-underline">Creeperkatze</a> · View <a href="https://github.com/creeperkatze/modrinth-embeds" target="_blank" class="text-modrinth-green no-underline">Source</a> ·
            <a href="https://github.com/creeperkatze/modrinth-embeds" target="_blank" class="text-yellow no-underline">&starf; On Github</a> · Not affiliated with Modrinth
        </footer>
        <script>
            const modrinthUrl = document.getElementById("modrinthUrl");
            const embedType = document.getElementById("embedType");
            const targetType = document.getElementById("targetType");
            const badgeSection = document.getElementById("badgeSection");
            const badgeMetric = document.getElementById("badgeMetric");
            const identifier = document.getElementById("identifier");
            const previewContainer = document.getElementById("previewContainer");
            const previewPlaceholder = document.getElementById("previewPlaceholder");
            const previewLink = document.getElementById("previewLink");
            const previewImg = document.getElementById("previewImg");
            const markdownOutput = document.getElementById("markdownOutput");
            const markdownPlaceholder = document.getElementById("markdownPlaceholder");
            const htmlOutput = document.getElementById("htmlOutput");
            const htmlPlaceholder = document.getElementById("htmlPlaceholder");
            const urlOutput = document.getElementById("urlOutput");
            const urlPlaceholder = document.getElementById("urlPlaceholder");
            const copyMarkdownBtn = document.getElementById("copyMarkdownBtn");
            const copyHtmlBtn = document.getElementById("copyHtmlBtn");
            const copyUrlBtn = document.getElementById("copyUrlBtn");
            const resetBtn = document.getElementById("resetBtn");
            const showProjects = document.getElementById("showProjects");
            const maxProjects = document.getElementById("maxProjects");
            const maxProjectsValue = document.getElementById("maxProjectsValue");
            const showVersions = document.getElementById("showVersions");
            const maxVersions = document.getElementById("maxVersions");
            const maxVersionsValue = document.getElementById("maxVersionsValue");
            const relativeTime = document.getElementById("relativeTime");
            const colorButtons = document.getElementById("colorButtons");
            const manualColorPicker = document.getElementById("manualColorPicker");
            const manualColorPickerContainer = document.getElementById("manualColorPickerContainer");
            const bgColorButtons = document.getElementById("bgColorButtons");
            const manualBgColorPicker = document.getElementById("manualBgColorPicker");
            const manualBgColorPickerContainer = document.getElementById("manualBgColorPickerContainer");
            const showProjectsSection = document.getElementById("showProjectsSection");
            const maxProjectsSection = document.getElementById("maxProjectsSection");
            const showVersionsSection = document.getElementById("showVersionsSection");
            const maxVersionsSection = document.getElementById("maxVersionsSection");
            const relativeTimeSection = document.getElementById("relativeTimeSection");
            const showSparklines = document.getElementById("showSparklines");
            const showSparklinesSection = document.getElementById("showSparklinesSection");
            const platformModrinth = document.getElementById("platformModrinth");
            const platformCurseforge = document.getElementById("platformCurseforge");
            const urlLabel = document.getElementById("urlLabel");
            const valueLabel = document.getElementById("valueLabel");

            let selectedColor = "1bd96a";
            let selectedBgColor = null;
            let selectedPlatform = "modrinth"; // "modrinth" or "curseforge"
            let curseforgeSlug = null; // Store the slug for link generation

            const CURSEFORGE_COLOR = "F16436";

            // HSL to Hex conversion (S=100%, L=75%)
            function hslToHex(h) {
                const s = 1,
                    l = 0.75;
                const c = (1 - Math.abs(2 * l - 1)) * s;
                const x = c * (1 - Math.abs(((h / 60) % 2) - 1));
                const m = l - c / 2;
                let r, g, b;

                if (h < 60) {
                    r = c;
                    g = x;
                    b = 0;
                } else if (h < 120) {
                    r = x;
                    g = c;
                    b = 0;
                } else if (h < 180) {
                    r = 0;
                    g = c;
                    b = x;
                } else if (h < 240) {
                    r = 0;
                    g = x;
                    b = c;
                } else if (h < 300) {
                    r = x;
                    g = 0;
                    b = c;
                } else {
                    r = c;
                    g = 0;
                    b = x;
                }

                const toHex = (val) =>
                    Math.round((val + m) * 255)
                        .toString(16)
                        .padStart(2, "0");
                return toHex(r) + toHex(g) + toHex(b);
            }

            // Create color buttons - different sets for Modrinth vs CurseForge
            const modrinthColors = ["1bd96a", ...[0, 30, 60, 150, 180, 210, 240, 270, 330].map((h) => hslToHex(h))];
            const curseforgeColors = ["F16436", ...[0, 30, 60, 150, 180, 210, 240, 270, 330].map((h) => hslToHex(h))];

            function getColors() {
                return selectedPlatform === "curseforge" ? curseforgeColors : modrinthColors;
            }

            let colors = getColors();

            function createColorButton(color, container) {
                const btn = document.createElement("button");
                btn.className = "color-btn" + (color === selectedColor ? " color-btn-selected" : "");
                btn.style.background = `#${color}`;
                btn.dataset.color = color;
                btn.onclick = () => {
                    selectedColor = color;
                    manualColorPicker.value = `#${color}`;

                    manualColorPickerContainer.style.background = `#${color}`;
                    manualColorPickerContainer.classList.remove("color-btn-selected");

                    document.querySelectorAll("[data-color]").forEach((b) => {
                        b.classList.toggle("color-btn-selected", b.dataset.color === selectedColor);
                    });

                    generate();
                    updateUrl();
                };
                container.appendChild(btn);
            }

            colors.forEach((color) => {
                createColorButton(color, colorButtons);
            });

            // Create background color buttons (transparent + predefined colors)
            const bgColors = [
                { name: "transparent", value: null },
                { name: "white", value: "ffffff" },
                { name: "black", value: "000000" },
            ];

            function createBgColorButton(colorObj, container) {
                const btn = document.createElement("button");
                const isSelected = selectedBgColor === colorObj.value;
                btn.className = "color-btn" + (isSelected ? " color-btn-selected" : "");

                if (colorObj.value === null) {
                    // Transparent button with checkerboard pattern
                    btn.style.background = `
                        linear-gradient(45deg, #ccc 25%, transparent 25%),
                        linear-gradient(-45deg, #ccc 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #ccc 75%),
                        linear-gradient(-45deg, transparent 75%, #ccc 75%)
                    `;
                    btn.style.backgroundPosition = "0 0, 0 10px, 10px -10px, -10px 0px";
                    btn.style.backgroundSize = "20px 20px";
                    btn.title = "Transparent";
                } else {
                    btn.style.background = `#${colorObj.value}`;
                }

                btn.dataset.bgColor = colorObj.value;
                btn.onclick = () => {
                    selectedBgColor = colorObj.value;

                    if (colorObj.value !== null) {
                        manualBgColorPicker.value = `#${colorObj.value}`;
                        manualBgColorPickerContainer.style.background = `#${colorObj.value}`;
                    }

                    manualBgColorPickerContainer.classList.remove("color-btn-selected");

                    document.querySelectorAll("[data-bg-color]").forEach((b) => {
                        b.classList.toggle("color-btn-selected", b.dataset.bgColor === String(selectedBgColor));
                    });

                    generate();
                    updateUrl();
                };
                container.appendChild(btn);
            }

            bgColors.forEach((colorObj) => {
                createBgColorButton(colorObj, bgColorButtons);
            });

            // Update warning messages based on platform
            function updateWarningMessages() {
                const slowWarningText = document.getElementById("apiSlowWarningText");
                const errorWarningText = document.getElementById("apiErrorWarningText");

                if (selectedPlatform === "curseforge") {
                    slowWarningText.textContent = "The CurseForge API is responding slowly. Embeds may take longer to load.";
                    errorWarningText.innerHTML = 'The CurseForge API is currently down. Check <a href="https://status.curseforge.com" target="_blank" class="underline hover:text-red-80">status.curseforge.com</a> for updates.';
                } else {
                    slowWarningText.textContent = "The Modrinth API is responding slowly. Embeds may take longer to load.";
                    errorWarningText.innerHTML = 'The Modrinth API is currently down. Check <a href="https://status.modrinth.com" target="_blank" class="underline hover:text-red-80">status.modrinth.com</a> for updates.';
                }
            }

            // Update labels based on platform
            function updateLabels() {
                const showVersionsLabel = document.getElementById("showVersionsLabel");
                const maxVersionsLabel = document.getElementById("maxVersionsLabel");

                if (selectedPlatform === "curseforge") {
                    showVersionsLabel.textContent = "Show Files";
                    maxVersionsLabel.textContent = "Max Files";
                } else {
                    showVersionsLabel.textContent = "Show Versions";
                    maxVersionsLabel.textContent = "Max Versions";
                }
            }

            // Platform toggle
            function setPlatform(platform) {
                selectedPlatform = platform;
                if (platform === "modrinth") {
                    platformModrinth.className = "flex-1 py-2.5 px-3 bg-modrinth-green text-black border-none rounded-xl text-sm font-semibold cursor-pointer transition-[filter] duration-200 hover:brightness-110";
                    platformCurseforge.className = "flex-1 py-2.5 px-3 bg-input-bg text-text-bright border border-border-dark rounded-xl text-sm font-semibold cursor-pointer transition-[filter] duration-200 hover:brightness-110";
                    modrinthUrl.placeholder = "https://modrinth.com/mod/fabric-api";
                    targetType.innerHTML = '<option value="user">User</option><option value="project">Project</option><option value="organization">Organization</option><option value="collection">Collection</option>';
                    targetType.value = "user";
                    selectedColor = "1bd96a";
                } else {
                    platformModrinth.className = "flex-1 py-2.5 px-3 bg-input-bg text-text-bright border border-border-dark rounded-xl text-sm font-semibold cursor-pointer transition-[filter] duration-200 hover:brightness-110";
                    platformCurseforge.className = "flex-1 py-2.5 px-3 bg-[#F16436] text-black border-none rounded-xl text-sm font-semibold cursor-pointer transition-[filter] duration-200 hover:brightness-110";
                    modrinthUrl.placeholder = "https://www.curseforge.com/minecraft/mc-mods/example-mod";
                    targetType.innerHTML = '<option value="project">Project</option>';
                    targetType.value = "project";
                    selectedColor = CURSEFORGE_COLOR;
                }

                // Update color picker and regenerate color buttons
                colors = getColors();
                colorButtons.innerHTML = "";
                colors.forEach((color) => {
                    createColorButton(color, colorButtons);
                });

                manualColorPicker.value = `#${selectedColor}`;
                manualColorPickerContainer.style.background = `#${selectedColor}`;
                document.querySelectorAll("[data-color]").forEach((b) => {
                    b.classList.toggle("color-btn-selected", b.dataset.color === selectedColor);
                });

                updateWarningMessages();
                updateLabels();
                updateUI();
                updateUrl();
            }

            // Reset to defaults for the current platform
            function resetToDefaults() {
                const isCurseForge = selectedPlatform === "curseforge";
                const defaultColor = isCurseForge ? CURSEFORGE_COLOR : "1bd96a";

                // Reset slug storage
                curseforgeSlug = null;

                // Reset embed type and target
                embedType.value = "card";
                targetType.value = isCurseForge ? "project" : "user";
                badgeMetric.value = "downloads";
                identifier.value = "";

                // Reset customization options
                showProjects.checked = true;
                maxProjects.value = 5;
                maxProjectsValue.textContent = "5";

                showVersions.checked = true;
                maxVersions.value = 5;
                maxVersionsValue.textContent = "5";

                relativeTime.checked = true;
                showSparklines.checked = true;

                // Reset colors
                selectedColor = defaultColor;
                selectedBgColor = null;

                // Update color picker UI
                colors = getColors();
                colorButtons.innerHTML = "";
                colors.forEach((color) => {
                    createColorButton(color, colorButtons);
                });

                manualColorPicker.value = `#${selectedColor}`;
                manualColorPickerContainer.style.background = `#${selectedColor}`;
                manualColorPickerContainer.classList.remove("color-btn-selected");

                document.querySelectorAll("[data-color]").forEach((b) => {
                    b.classList.toggle("color-btn-selected", b.dataset.color === selectedColor);
                });

                // Reset background color picker
                manualBgColorPicker.value = "#ffffff";
                manualBgColorPickerContainer.style.background = "transparent";
                manualBgColorPickerContainer.classList.remove("color-btn-selected");

                document.querySelectorAll("[data-bg-color]").forEach((b) => {
                    b.classList.toggle("color-btn-selected", b.dataset.bgColor === "null");
                });

                // Reset URL
                modrinthUrl.value = "";

                updateUI();
                updateUrl();
                generate();
            }

            platformModrinth.addEventListener("click", () => {
                setPlatform("modrinth");
                resetToDefaults();
            });
            platformCurseforge.addEventListener("click", () => {
                setPlatform("curseforge");
                resetToDefaults();
            });

            // Reset button
            resetBtn.addEventListener("click", resetToDefaults);

            // Basic section toggle
            const basicToggle = document.getElementById("basicToggle");
            const basicContent = document.getElementById("basicContent");
            const basicChevron = document.getElementById("basicChevron");
            let basicExpanded = true;

            basicToggle.addEventListener("click", () => {
                basicExpanded = !basicExpanded;
                basicContent.classList.toggle("hidden", !basicExpanded);
                basicChevron.classList.toggle("rotate-180", basicExpanded);
            });

            // Customization toggle
            const customizationToggle = document.getElementById("customizationToggle");
            const customizationContent = document.getElementById("customizationContent");
            const customizationChevron = document.getElementById("customizationChevron");
            let customizationExpanded = false;

            customizationToggle.addEventListener("click", () => {
                customizationExpanded = !customizationExpanded;
                customizationContent.classList.toggle("hidden", !customizationExpanded);
                customizationChevron.classList.toggle("rotate-180", customizationExpanded);
            });

            manualColorPicker.addEventListener("input", (e) => {
                selectedColor = e.target.value.substring(1);

                manualColorPickerContainer.style.background = `#${selectedColor}`;

                // deselect all preset buttons
                document.querySelectorAll("[data-color]").forEach((b) => {
                    b.classList.remove("color-btn-selected");
                });

                // select manual picker
                manualColorPickerContainer.classList.add("color-btn-selected");

                generate();
                updateUrl();
            });

            manualBgColorPicker.addEventListener("input", (e) => {
                selectedBgColor = e.target.value.substring(1);

                manualBgColorPickerContainer.style.background = `#${selectedBgColor}`;

                // deselect all preset buttons
                document.querySelectorAll("[data-bg-color]").forEach((b) => {
                    b.classList.remove("color-btn-selected");
                });

                // select manual picker
                manualBgColorPickerContainer.classList.add("color-btn-selected");

                generate();
                updateUrl();
            });
            // URL state management functions
            function getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const platform = params.get("platform") || "modrinth";
                const defaultColor = platform === "curseforge" ? CURSEFORGE_COLOR : "1bd96a";
                return {
                    platform,
                    type: params.get("type") || "card",
                    target: params.get("target") || "user",
                    metric: params.get("metric") || "downloads",
                    value: params.get("value") || "",
                    showProjects: params.get("showProjects") !== "false",
                    maxProjects: parseInt(params.get("maxProjects")) || 5,
                    showVersions: params.get("showVersions") !== "false",
                    maxVersions: parseInt(params.get("maxVersions")) || 5,
                    relativeTime: params.get("relativeTime") !== "false",
                    showSparklines: params.get("showSparklines") !== "false",
                    color: params.get("color") || defaultColor,
                    backgroundColor: params.get("backgroundColor") || null,
                };
            }

            function updateUrl() {
                const params = new URLSearchParams();
                const type = embedType.value;
                const target = targetType.value;
                const metric = badgeMetric.value;
                const value = identifier.value.trim();

                if (selectedPlatform !== "modrinth") params.set("platform", selectedPlatform);
                if (type !== "card") params.set("type", type);
                params.set("target", target);
                if (metric !== "downloads") params.set("metric", metric);
                if (value) params.set("value", value);

                // Only add customization params for cards
                if (type === "card") {
                    if (!showProjects.checked && selectedPlatform === "modrinth") params.set("showProjects", "false");
                    if (maxProjects.value !== "5" && selectedPlatform === "modrinth") params.set("maxProjects", maxProjects.value);
                    if (!showVersions.checked) params.set("showVersions", "false");
                    if (maxVersions.value !== "5") params.set("maxVersions", maxVersions.value);
                    if (!relativeTime.checked) params.set("relativeTime", "false");
                    if (!showSparklines.checked) params.set("showSparklines", "false");
                    const defaultColor = selectedPlatform === "curseforge" ? CURSEFORGE_COLOR : "1bd96a";
                    if (selectedColor !== defaultColor) params.set("color", selectedColor);
                    if (selectedBgColor !== null) params.set("backgroundColor", selectedBgColor);
                } else {
                    const defaultColor = selectedPlatform === "curseforge" ? CURSEFORGE_COLOR : "1bd96a";
                    if (selectedColor !== defaultColor) params.set("color", selectedColor);
                    if (selectedBgColor !== null) params.set("backgroundColor", selectedBgColor);
                }

                const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
                window.history.replaceState(null, "", newUrl);
            }

            function loadFromUrl() {
                const params = getUrlParams();

                // Set platform first
                setPlatform(params.platform);

                embedType.value = params.type;
                targetType.value = params.target;
                badgeMetric.value = params.metric;
                identifier.value = params.value;

                showProjects.checked = params.showProjects;
                maxProjects.value = params.maxProjects;
                maxProjectsValue.textContent = params.maxProjects;

                showVersions.checked = params.showVersions;
                maxVersions.value = params.maxVersions;
                maxVersionsValue.textContent = params.maxVersions;

                relativeTime.checked = params.relativeTime;
                showSparklines.checked = params.showSparklines;
                selectedColor = params.color;
                selectedBgColor = params.backgroundColor;

                colors = getColors();

                const isPresetColor = colors.includes(selectedColor);

                manualColorPicker.value = `#${selectedColor}`;
                manualColorPickerContainer.style.background = `#${selectedColor}`;

                manualColorPickerContainer.classList.toggle("color-btn-selected", !isPresetColor);

                document.querySelectorAll("[data-color]").forEach((b) => {
                    b.classList.toggle("color-btn-selected", b.dataset.color === selectedColor);
                });

                // Background color
                const isPresetBgColor = bgColors.some((c) => String(c.value) === String(selectedBgColor));

                if (selectedBgColor !== null) {
                    manualBgColorPicker.value = `#${selectedBgColor}`;
                    manualBgColorPickerContainer.style.background = `#${selectedBgColor}`;
                }

                manualBgColorPickerContainer.classList.toggle("color-btn-selected", !isPresetBgColor && selectedBgColor !== null);

                document.querySelectorAll("[data-bg-color]").forEach((b) => {
                    b.classList.toggle("color-btn-selected", b.dataset.bgColor === String(selectedBgColor));
                });

                if (hasCustomizationFromUrl(params)) {
                    customizationExpanded = true;
                    customizationContent.classList.remove("hidden");
                    customizationChevron.classList.add("rotate-180");
                }
            }

            function parseModrinthUrl(url) {
                try {
                    const urlObj = new URL(url);

                    // Handle CurseForge URLs
                    if (urlObj.hostname.includes("curseforge.com")) {
                        const pathParts = urlObj.pathname.split("/").filter((p) => p);
                        if (pathParts.length < 3) return null;

                        // CurseForge URLs are like: /minecraft/mc-mods/geckolib
                        const game = pathParts[0];
                        const category = pathParts[1];
                        const slug = pathParts[2];

                        if (slug) {
                            return { type: "project", id: slug, slug, isCurseForge: true };
                        }
                        return null;
                    }

                    // Handle Modrinth URLs
                    if (!urlObj.hostname.includes("modrinth.com")) return null;

                    const pathParts = urlObj.pathname.split("/").filter((p) => p);
                    if (pathParts.length < 2) return null;

                    const type = pathParts[0];
                    const id = pathParts[1];

                    // Map URL types to our target types
                    const typeMap = {
                        project: "project",
                        mod: "project",
                        modpack: "project",
                        shader: "project",
                        resourcepack: "project",
                        datapack: "project",
                        plugin: "project",
                        user: "user",
                        organization: "organization",
                        collection: "collection",
                    };

                    const mappedType = typeMap[type];
                    if (!mappedType) return null;

                    return { type: mappedType, id };
                } catch {
                    return null;
                }
            }

            modrinthUrl.addEventListener("input", async () => {
                const urlValue = modrinthUrl.value.trim();

                // Auto-detect platform from URL
                if (urlValue.includes("curseforge.com")) {
                    setPlatform("curseforge");
                } else if (urlValue.includes("modrinth.com")) {
                    setPlatform("modrinth");
                }

                const parsed = parseModrinthUrl(urlValue);
                if (parsed) {
                    targetType.value = parsed.type;

                    // For CurseForge, we need to resolve the slug to an ID
                    if (parsed.isCurseForge && parsed.slug) {
                        curseforgeSlug = parsed.slug; // Store the slug for link generation
                        try {
                            identifier.value = "Resolving...";
                            const response = await fetch(`/curseforge/lookup/${encodeURIComponent(parsed.slug)}`);
                            if (!response.ok) {
                                throw new Error("Mod not found");
                            }
                            const data = await response.json();
                            identifier.value = data.id;
                            updateUrl();
                            updateUI();
                        } catch (err) {
                            identifier.value = "";
                            curseforgeSlug = null;
                            console.error("Failed to resolve CurseForge slug:", err);
                        }
                    } else {
                        curseforgeSlug = null;
                        identifier.value = parsed.id;
                        updateUrl();
                        updateUI();
                    }
                }
            });

            function updateBadgeOptions() {
                if (selectedPlatform === "curseforge") {
                    badgeMetric.innerHTML = '<option value="downloads">Downloads</option><option value="rank">Rank</option><option value="versions">Versions</option>';
                } else {
                    const isUserOrgOrCollection = ["user", "organization", "collection"].includes(targetType.value);
                    badgeMetric.innerHTML = isUserOrgOrCollection
                        ? '<option value="downloads">Downloads</option><option value="followers">Followers</option><option value="projects">Projects</option>'
                        : '<option value="downloads">Downloads</option><option value="followers">Followers</option><option value="versions">Versions</option>';
                }
            }

            function updateUI() {
                const placeholders = selectedPlatform === "curseforge"
                    ? { project: "Enter project ID or slug" }
                    : {
                        user: "Enter username or id",
                        project: "Enter project slug or id",
                        organization: "Enter organization slug or id",
                        collection: "Enter collection id",
                    };
                identifier.placeholder = placeholders[targetType.value] || "";
                valueLabel.textContent = selectedPlatform === "curseforge" ? "Project ID" : "Value";
                const isCard = embedType.value === "card";
                const isBadge = embedType.value === "badge";

                badgeSection.classList.toggle("hidden", !isBadge);
                updateBadgeOptions();

                // Show/hide customization sections based on target type
                const isProject = targetType.value === "project";
                const isUserOrgOrCollection = ["user", "organization", "collection"].includes(targetType.value);

                showProjectsSection.classList.toggle("hidden", !(isCard && isUserOrgOrCollection && selectedPlatform === "modrinth"));
                maxProjectsSection.classList.toggle("hidden", !(isCard && isUserOrgOrCollection && showProjects.checked && selectedPlatform === "modrinth"));
                showVersionsSection.classList.toggle("hidden", !(isCard && isProject));
                maxVersionsSection.classList.toggle("hidden", !(isCard && isProject && showVersions.checked));
                relativeTimeSection.classList.toggle("hidden", !(isCard && isProject && showVersions.checked));
                showSparklinesSection.classList.toggle("hidden", !isCard);

                generate();
            }

            async function generate() {
                const startTime = performance.now();
                const type = targetType.value;
                const identifierValue = identifier.value.trim();

                if (!identifierValue) {
                    previewContainer.classList.add("text-text-muted");
                    previewPlaceholder.classList.remove("hidden");
                    previewLink.classList.add("hidden");
                    markdownOutput.classList.add("text-text-muted");
                    markdownOutput.innerHTML = '<span id="markdownPlaceholder">Your markdown code will appear here</span>';
                    htmlOutput.classList.add("text-text-muted");
                    htmlOutput.innerHTML = '<span id="htmlPlaceholder">Your HTML code will appear here</span>';
                    urlOutput.classList.add("text-text-muted");
                    urlOutput.innerHTML = '<span id="urlPlaceholder">Your URL will appear here</span>';
                    copyMarkdownBtn.disabled = true;
                    copyHtmlBtn.disabled = true;
                    copyUrlBtn.disabled = true;
                    document.getElementById("generationTime").textContent = "";
                    document.getElementById("generationIcon").classList.add("hidden");
                    document.getElementById("loaderIcon").classList.add("hidden");
                    document.getElementById("apiSlowWarning").classList.add("hidden");
                    document.getElementById("apiErrorWarning").classList.add("hidden");
                    return;
                }

                // Show loader and placeholder while fetching
                document.getElementById("loaderIcon").classList.remove("hidden");
                document.getElementById("generationIcon").classList.add("hidden");
                document.getElementById("generationTime").textContent = "";
                document.getElementById("apiSlowWarning").classList.add("hidden");
                document.getElementById("apiErrorWarning").classList.add("hidden");
                previewContainer.classList.add("text-text-muted");
                previewPlaceholder.classList.remove("hidden");
                previewLink.classList.add("hidden");

                // Build URL with customization parameters
                let url;
                if (embedType.value === "card") {
                    const urlParams = new URLSearchParams();
                    if (selectedPlatform === "curseforge") {
                        // CurseForge card URL: /curseforge/project/:modId
                        if (!showVersions.checked) {
                            urlParams.set("showVersions", "false");
                        }
                        if (maxVersions.value !== "5") {
                            urlParams.set("maxVersions", maxVersions.value);
                        }
                        if (!relativeTime.checked) {
                            urlParams.set("relativeTime", "false");
                        }
                        if (!showSparklines.checked) {
                            urlParams.set("showSparklines", "false");
                        }
                        if (selectedColor !== CURSEFORGE_COLOR) {
                            urlParams.set("color", selectedColor);
                        }
                        if (selectedBgColor !== null) {
                            urlParams.set("backgroundColor", selectedBgColor);
                        }
                        const queryString = urlParams.toString();
                        url = `${window.location.origin}/curseforge/project/${identifierValue}${queryString ? "?" + queryString : ""}`;
                    } else {
                        // Modrinth card URL
                        if (!showProjects.checked && ["user", "organization", "collection"].includes(type)) {
                            urlParams.set("showProjects", "false");
                        }
                        if (maxProjects.value !== "5" && ["user", "organization", "collection"].includes(type)) {
                            urlParams.set("maxProjects", maxProjects.value);
                        }
                        if (!showVersions.checked && type === "project") {
                            urlParams.set("showVersions", "false");
                        }
                        if (maxVersions.value !== "5" && type === "project") {
                            urlParams.set("maxVersions", maxVersions.value);
                        }
                        if (!relativeTime.checked && type === "project") {
                            urlParams.set("relativeTime", "false");
                        }
                        if (!showSparklines.checked) {
                            urlParams.set("showSparklines", "false");
                        }
                        if (selectedColor !== "1bd96a") {
                            urlParams.set("color", selectedColor);
                        }
                        if (selectedBgColor !== null) {
                            urlParams.set("backgroundColor", selectedBgColor);
                        }
                        const queryString = urlParams.toString();
                        url = `${window.location.origin}/${type}/${identifierValue}${queryString ? "?" + queryString : ""}`;
                    }
                } else {
                    const badgeParams = new URLSearchParams();
                    if (selectedColor !== (selectedPlatform === "curseforge" ? CURSEFORGE_COLOR : "1bd96a")) {
                        badgeParams.set("color", selectedColor);
                    }
                    if (selectedBgColor !== null) {
                        badgeParams.set("backgroundColor", selectedBgColor);
                    }
                    const badgeQuery = badgeParams.toString();
                    if (selectedPlatform === "curseforge") {
                        url = `${window.location.origin}/curseforge/project/${identifierValue}/${badgeMetric.value}${badgeQuery ? "?" + badgeQuery : ""}`;
                    } else {
                        url = `${window.location.origin}/${type}/${identifierValue}/${badgeMetric.value}${badgeQuery ? "?" + badgeQuery : ""}`;
                    }
                }

                const modrinthUrl = selectedPlatform === "curseforge"
                    ? `https://www.curseforge.com/minecraft/mc-mods/${curseforgeSlug || identifierValue}`
                    : `https://modrinth.com/${type}/${identifierValue}`;
                const cacheBuster = `timestamp=${Date.now()}`;
                const urlForDiscord = `${url}${url.includes("?") ? "&" : "?"}${cacheBuster}`;

                markdownOutput.classList.remove("text-text-muted");
                markdownOutput.classList.add("text-text-bright");
                markdownOutput.textContent = `[![${identifierValue}](${url})](${modrinthUrl})`;

                htmlOutput.classList.remove("text-text-muted");
                htmlOutput.classList.add("text-text-bright");
                htmlOutput.textContent = `<a href="${modrinthUrl}"><img src="${url}" alt="${identifierValue}" /></a>`;

                urlOutput.classList.remove("text-text-muted");
                urlOutput.classList.add("text-text-bright");
                urlOutput.textContent = urlForDiscord;

                copyMarkdownBtn.disabled = false;
                copyHtmlBtn.disabled = false;
                copyUrlBtn.disabled = false;

                previewImg.src = `${url}${url.includes("?") ? "&" : "?"}t=${Date.now()}`;
                previewImg.onload = async () => {
                    const endTime = performance.now();
                    const generationTime = Math.round(endTime - startTime);
                    document.getElementById("generationTime").textContent = `${generationTime}ms`;
                    document.getElementById("generationIcon").classList.remove("hidden");
                    document.getElementById("loaderIcon").classList.add("hidden");

                    // Check for API errors by looking at response headers
                    try {
                        const res = await fetch(url, { method: 'HEAD' });
                        const errorStatus = res.headers.get("X-Error-Status");

                        if (errorStatus && (errorStatus.startsWith('5') || errorStatus === '502' || errorStatus === '503' || errorStatus === '504')) {
                            document.getElementById("apiErrorWarning").classList.remove("hidden");
                        } else {
                            document.getElementById("apiErrorWarning").classList.add("hidden");
                        }
                    } catch {
                        document.getElementById("apiErrorWarning").classList.add("hidden");
                    }

                    // Show slow API warning if generation time is too long
                    if (generationTime > 2000) {
                        document.getElementById("apiSlowWarning").classList.remove("hidden");
                    } else {
                        document.getElementById("apiSlowWarning").classList.add("hidden");
                    }

                    // Show image after load
                    previewLink.href = modrinthUrl;
                    previewContainer.classList.remove("text-text-muted");
                    previewPlaceholder.classList.add("hidden");
                    previewLink.classList.remove("hidden");

                    try {
                        const metaPath = selectedPlatform === "curseforge"
                            ? `/meta/curseforge/${encodeURIComponent(identifierValue)}`
                            : `/meta/${type}/${encodeURIComponent(identifierValue)}`;
                        const res = await fetch(metaPath);
                        if (res.ok) {
                            const data = await res.json();
                            if (data?.name) {
                                markdownOutput.textContent = `[![${data.name}](${url})](${modrinthUrl})`;
                                htmlOutput.textContent = `<a href="${modrinthUrl}"><img src="${url}" alt="${data.name}" /></a>`;
                            }
                        }
                    } catch {}
                };

                previewImg.onerror = () => {
                    document.getElementById("loaderIcon").classList.add("hidden");
                    document.getElementById("generationIcon").classList.add("hidden");
                    document.getElementById("generationTime").textContent = "";
                    document.getElementById("apiSlowWarning").classList.add("hidden");

                    // Check if this is an API error by attempting to fetch the image status
                    fetch(url, { method: 'HEAD' })
                        .then(res => {
                            const errorStatus = res.headers.get("X-Error-Status");
                            if (errorStatus && (errorStatus.startsWith('5') || errorStatus === '502' || errorStatus === '503' || errorStatus === '504')) {
                                document.getElementById("apiErrorWarning").classList.remove("hidden");
                            } else {
                                document.getElementById("apiErrorWarning").classList.add("hidden");
                            }
                        })
                        .catch(() => {
                            document.getElementById("apiErrorWarning").classList.add("hidden");
                        });

                    previewContainer.classList.add("text-text-muted");
                    previewPlaceholder.classList.remove("hidden");
                    previewLink.classList.add("hidden");
                };
            }

            embedType.addEventListener("change", () => {
                updateUI();
                updateUrl();
            });
            targetType.addEventListener("change", () => {
                updateUI();
                updateUrl();
            });
            badgeMetric.addEventListener("change", () => {
                generate();
                updateUrl();
            });
            identifier.addEventListener("input", () => {
                generate();
                updateUrl();
            });
            showProjects.addEventListener("change", () => {
                updateUI();
                updateUrl();
            });
            maxProjects.addEventListener("input", () => {
                maxProjectsValue.textContent = maxProjects.value;
                generate();
                updateUrl();
            });
            showVersions.addEventListener("change", () => {
                updateUI();
                updateUrl();
            });
            maxVersions.addEventListener("input", () => {
                maxVersionsValue.textContent = maxVersions.value;
                generate();
                updateUrl();
            });
            relativeTime.addEventListener("change", () => {
                generate();
                updateUrl();
            });
            showSparklines.addEventListener("change", () => {
                generate();
                updateUrl();
            });

            function copyMarkdown() {
                const text = markdownOutput.textContent.trim();
                if (!text || text === "Your markdown code will appear here") return;

                navigator.clipboard.writeText(text).then(() => {
                    const span = copyMarkdownBtn.querySelector("span");
                    const originalText = span.textContent;
                    span.textContent = "Copied!";
                    setTimeout(() => {
                        span.textContent = originalText;
                    }, 2000);
                });
            }

            function copyHtml() {
                const text = htmlOutput.textContent.trim();
                if (!text || text === "Your HTML code will appear here") return;

                navigator.clipboard.writeText(text).then(() => {
                    const span = copyHtmlBtn.querySelector("span");
                    const originalText = span.textContent;
                    span.textContent = "Copied!";
                    setTimeout(() => {
                        span.textContent = originalText;
                    }, 2000);
                });
            }

            function copyUrl() {
                const text = urlOutput.textContent.trim();
                if (!text || text === "Your URL will appear here") return;

                navigator.clipboard.writeText(text).then(() => {
                    const span = copyUrlBtn.querySelector("span");
                    const originalText = span.textContent;
                    span.textContent = "Copied!";
                    setTimeout(() => {
                        span.textContent = originalText;
                    }, 2000);
                });
            }

            function hasCustomizationFromUrl(params) {
                const defaultColor = params.platform === "curseforge" ? CURSEFORGE_COLOR : "1bd96a";
                return params.showProjects === false || params.maxProjects !== 5 || params.showVersions === false || params.maxVersions !== 5 || params.relativeTime === false || params.showSparklines === false || params.color !== defaultColor || params.backgroundColor !== null;
            }

            loadFromUrl();
            updateUI();
        </script>
    </body>
</html>
